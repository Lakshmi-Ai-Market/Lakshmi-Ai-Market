<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakshmi AI Trades - Market Analyzer</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        select, input, button {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 500px;
        }

        .metrics-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 500px;
            overflow-y: auto;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .analyze-btn {
                align-self: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Lakshmi AI Trades</h1>
            <p>Advanced Market Analysis Dashboard</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="symbol">Symbol</label>
                <select id="symbol">
                    <option value="^NSEI">NIFTY 50</option>
                    <option value="^BSESN">SENSEX</option>
                    <option value="^NSEBANK">BANK NIFTY</option>
                    <option value="RELIANCE.NS">Reliance</option>
                    <option value="TCS.NS">TCS</option>
                    <option value="INFY.NS">Infosys</option>
                    <option value="HDFCBANK.NS">HDFC Bank</option>
                    <option value="ICICIBANK.NS">ICICI Bank</option>
                </select>
            </div>

            <div class="control-group">
                <label for="period">Period</label>
                <select id="period">
                    <option value="1d">1 Day</option>
                    <option value="5d">5 Days</option>
                    <option value="1mo" selected>1 Month</option>
                    <option value="3mo">3 Months</option>
                    <option value="6mo">6 Months</option>
                    <option value="1y">1 Year</option>
                </select>
            </div>

            <div class="control-group">
                <label for="interval">Interval</label>
                <select id="interval">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="1d" selected>1 Day</option>
                </select>
            </div>

            <button class="analyze-btn" onclick="analyzeMarket()">
                📊 Analyze Market
            </button>
        </div>

        <div class="error" id="errorMessage"></div>
        
        <div class="loading" id="loading">
            <h3>🔄 Analyzing Market Data...</h3>
            <p>Fetching real-time data from multiple sources</p>
        </div>

        <div class="dashboard">
            <div class="chart-container">
                <div id="chart"></div>
            </div>
            
            <div class="metrics-panel">
                <h3 style="margin-bottom: 20px; color: #667eea;">📈 Market Metrics</h3>
                <div id="metrics">
                    <div class="metric-card">
                        <div class="metric-title">Current Price</div>
                        <div class="metric-value" id="currentPrice">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Price Change</div>
                        <div class="metric-value" id="priceChange">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Change %</div>
                        <div class="metric-value" id="changePercent">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Volume</div>
                        <div class="metric-value" id="volume">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">52W High</div>
                        <div class="metric-value" id="high52w">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">52W Low</div>
                        <div class="metric-value" id="low52w">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let candleSeries;
        let currentSymbol = '^NSEI';
        let currentPeriod = '1mo';
        let currentInterval = '1d';

        // Initialize chart
        function initChart() {
            const chartContainer = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 450,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: '#333',
                },
                grid: {
                    vertLines: {
                        color: '#f0f0f0',
                    },
                    horzLines: {
                        color: '#f0f0f0',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#cccccc',
                },
                timeScale: {
                    borderColor: '#cccccc',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            // Handle resize
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: chartContainer.clientWidth });
            });
        }

        // BULLETPROOF data fetching with proper error handling
        async function fetchMarketData() {
            try {
                showLoading(true);
                
                const response = await fetch('/api/market-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        period: currentPeriod,
                        interval: currentInterval
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 Raw response:', data);
                
                // BULLETPROOF data parsing - handles ALL possible response formats
                let chartData = [];
                let metaData = {};
                
                if (data && data.success) {
                    // Method 1: Standard Yahoo Finance format
                    if (data.chart && 
                        data.chart.result && 
                        Array.isArray(data.chart.result) && 
                        data.chart.result.length > 0) {
                        
                        const result = data.chart.result[0];
                        console.log('📊 Chart result:', result);
                        
                        if (result.timestamp && 
                            Array.isArray(result.timestamp) && 
                            result.timestamp.length > 0 &&
                            result.indicators && 
                            result.indicators.quote && 
                            Array.isArray(result.indicators.quote) && 
                            result.indicators.quote.length > 0) {
                            
                            const timestamps = result.timestamp;
                            const quotes = result.indicators.quote[0];
                            
                            console.log('📊 Timestamps length:', timestamps.length);
                            console.log('📊 Quotes:', quotes);
                            
                            // Ensure all required arrays exist and have data
                            if (quotes.open && Array.isArray(quotes.open) && quotes.open.length > 0 &&
                                quotes.high && Array.isArray(quotes.high) && quotes.high.length > 0 &&
                                quotes.low && Array.isArray(quotes.low) && quotes.low.length > 0 &&
                                quotes.close && Array.isArray(quotes.close) && quotes.close.length > 0) {
                                
                                const minLength = Math.min(
                                    timestamps.length,
                                    quotes.open.length,
                                    quotes.high.length,
                                    quotes.low.length,
                                    quotes.close.length
                                );
                                
                                console.log('📊 Processing', minLength, 'data points');
                                
                                for (let i = 0; i < minLength; i++) {
                                    if (quotes.open[i] !== null && quotes.open[i] !== undefined &&
                                        quotes.high[i] !== null && quotes.high[i] !== undefined &&
                                        quotes.low[i] !== null && quotes.low[i] !== undefined &&
                                        quotes.close[i] !== null && quotes.close[i] !== undefined) {
                                        
                                        chartData.push({
                                            time: timestamps[i],
                                            open: parseFloat(quotes.open[i]),
                                            high: parseFloat(quotes.high[i]),
                                            low: parseFloat(quotes.low[i]),
                                            close: parseFloat(quotes.close[i])
                                        });
                                    }
                                }
                                
                                metaData = result.meta || {};
                                console.log('✅ Successfully parsed', chartData.length, 'candles');
                            }
                        }
                    }
                }
                
                // Final validation
                if (!Array.isArray(chartData) || chartData.length === 0) {
                    throw new Error('No valid market data received. Server returned data but frontend could not parse it.');
                }
                
                console.log('✅ Final chart data:', chartData.length, 'points');
                console.log('📊 Sample data point:', chartData[0]);
                
                updateChart(chartData);
                updateMetrics(metaData);
                
            } catch (error) {
                console.error('❌ Frontend error:', error);
                console.error('❌ Error stack:', error.stack);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function updateChart(data) {
            if (!candleSeries || !Array.isArray(data) || data.length === 0) {
                console.error('❌ Cannot update chart: invalid data');
                return;
            }
            
            try {
                console.log('📊 Updating chart with', data.length, 'points');
                candleSeries.setData(data);
                chart.timeScale().fitContent();
                console.log('✅ Chart updated successfully');
            } catch (error) {
                console.error('❌ Chart update failed:', error);
            }
        }

        function updateMetrics(meta) {
            try {
                document.getElementById('currentPrice').textContent = 
                    meta.currentPrice ? `₹${meta.currentPrice.toFixed(2)}` : '--';
                
                const priceChange = meta.priceChange || 0;
                const changePercent = meta.priceChangePct || 0;
                
                const priceChangeEl = document.getElementById('priceChange');
                const changePercentEl = document.getElementById('changePercent');
                
                priceChangeEl.textContent = `₹${priceChange.toFixed(2)}`;
                changePercentEl.textContent = `${changePercent.toFixed(2)}%`;
                
                // Color coding
                const colorClass = priceChange >= 0 ? 'positive' : 'negative';
                priceChangeEl.className = `metric-value ${colorClass}`;
                changePercentEl.className = `metric-value ${colorClass}`;
                
                document.getElementById('volume').textContent = 
                    meta.volume ? meta.volume.toLocaleString() : '--';
                document.getElementById('high52w').textContent = 
                    meta.fiftyTwoWeekHigh ? `₹${meta.fiftyTwoWeekHigh.toFixed(2)}` : '--';
                document.getElementById('low52w').textContent = 
                    meta.fiftyTwoWeekLow ? `₹${meta.fiftyTwoWeekLow.toFixed(2)}` : '--';
                    
            } catch (error) {
                console.error('❌ Metrics update failed:', error);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const analyzeBtn = document.querySelector('.analyze-btn');
            
            if (show) {
                loading.classList.add('show');
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = '🔄 Analyzing...';
            } else {
                loading.classList.remove('show');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '📊 Analyze Market';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        function analyzeMarket() {
            currentSymbol = document.getElementById('symbol').value;
            currentPeriod = document.getElementById('period').value;
            currentInterval = document.getElementById('interval').value;
            
            console.log('🚀 Starting analysis:', { currentSymbol, currentPeriod, currentInterval });
            fetchMarketData();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Lakshmi AI Trades Dashboard');
            initChart();
            
            // Auto-analyze on load
            setTimeout(() => {
                analyzeMarket();
            }, 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97eeb9ac85c1a73e',t:'MTc1Nzg0MDc1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
