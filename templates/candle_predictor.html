<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° Ultra AI Trader ‚Äî Futuristic Candles & Strategies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#020617; /* slate-950-ish */
      --bg2:#0b1023;
      --grid:#11182755;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --neon:#14f195;
      --neon-p:#22d3ee;
      --neon-m:#a78bfa;
      --danger:#fb7185;
      --bull:#22c55e;
      --bear:#ef4444;
      --card:#0b122a;
      --card-2:#0d1530;
    }
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, #0ea5e925, transparent),
        radial-gradient(1000px 700px at 90% 10%, #a78bfa22, transparent),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .glass{ background: linear-gradient(180deg, #0b122aE6, #0b122ab3); backdrop-filter: blur(10px); border:1px solid #1f2a44; }
    .glass2{ background: linear-gradient(180deg, #0d1530ee, #0d1530c0); border:1px solid #243155; }
    .soft-shadow{ box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 2px 10px rgba(0,0,0,0.3); }
    .btn-primary{ background: linear-gradient(135deg, #0ea5e9, #22d3ee); color:#041018; }
    .btn-primary:hover{ filter: brightness(1.06); }
    .btn-ghost{ background:#0c142f; border:1px solid #21325b; color:#cbd5e1; }
    .btn-ghost:hover{ background:#101b3d; }
    .panel-title{ color:#e2e8f0 }
    .neon{ text-shadow: 0 0 18px #14f195, 0 0 6px #14f195; }
    .neon-p{ text-shadow: 0 0 14px #22d3ee; }
    .chip{ background:#0b132e; border:1px dashed #1d2b53; color:#a5b4fc }
    .tip{ pointer-events:none; }
    .pulse{
      animation: pulseGlow 2s ease-in-out infinite;
    }
    @keyframes pulseGlow{
      0%{ box-shadow: 0 0 0 0 rgba(20,241,149,0.35); }
      70%{ box-shadow: 0 0 0 12px rgba(20,241,149,0); }
      100%{ box-shadow: 0 0 0 0 rgba(20,241,149,0); }
    }
    .glow-ring{ box-shadow: 0 0 0 2px #1f2a44, 0 0 0 6px #0ea5e955, inset 0 0 24px #0ea5e922; }
    .on{ background:linear-gradient(135deg, #22c55e, #86efac); color:#01200f; }
    .off{ background:#0f172a; color:#94a3b8; border:1px solid #1f2a44;}
    .grid-dot{
      background-image: radial-gradient(#293551 1px, transparent 0);
      background-size: 22px 22px;
      background-position: -10px -10px;
    }
    .badge{
      border:1px solid #1f2a44; background: #0b132e; color:#8badd9;
    }
    .title-grad{
      background: linear-gradient(90deg,#e2e8f0 0%, #22d3ee 40%, #a78bfa 80%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="max-w-7xl mx-auto px-6 md:px-10 pt-8 pb-6">
    <div class="flex items-start md:items-center justify-between gap-6 flex-col md:flex-row">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-fuchsia-500 flex items-center justify-center text-slate-900 text-2xl glow-ring">‚ö°</div>
        <div>
          <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight title-grad">Ultra AI Trader</h1>
          <p class="text-sm text-slate-300">Futuristic candles, smart strategies, and an AI-style narrative.</p>
        </div>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <span class="badge text-xs px-3 py-1 rounded-lg">Private demo ‚Ä¢ Client-side only</span>
        <a href="#" class="btn-ghost px-4 py-2 rounded-xl soft-shadow">Docs</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-6 md:px-10 pb-16">
    <section class="grid lg:grid-cols-3 gap-6">
      <!-- Controls -->
      <div class="lg:col-span-1 glass soft-shadow rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <h2 class="panel-title font-bold text-lg">Control Center</h2>
          <span class="text-xs chip px-2 py-1 rounded-md">AI mode ready</span>
        </div>

        <div class="mt-4 space-y-4">
          <!-- Symbol + Timeframe -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-400">Symbol</label>
              <select id="symbolPicker" class="w-full mt-1 bg-[#0d1530] border border-[#293a69] rounded-xl p-3 text-slate-100">
                <option value="NSE:NIFTY">NSE:NIFTY</option>
                <option value="NSE:BANKNIFTY">NSE:BANKNIFTY</option>
                <option value="NSE:RELIANCE">NSE:RELIANCE</option>
                <option value="NSE:TCS">NSE:TCS</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-400">Timeframe</label>
              <select id="timeframe" class="w-full mt-1 bg-[#0d1530] border border-[#293a69] rounded-xl p-3 text-slate-100">
                <option value="1m">1m</option>
                <option value="5m" selected>5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
                <option value="1d">1D</option>
              </select>
            </div>
          </div>

          <!-- Input -->
          <div>
            <label class="text-xs text-slate-400">Paste data</label>
            <p class="text-[11px] text-slate-400 mt-1">Use: open,high,low,close[,volume] or time,open,high,low,close[,volume]. Time is optional.</p>
            <textarea id="dataInput" rows="7" class="mt-2 w-full bg-[#0d1530] border border-[#293a69] rounded-xl p-3 text-slate-100 placeholder-slate-500" placeholder="45710,45745,45690,45720,152300&#10;45720,45750,45700,45735,141900&#10;..."></textarea>
          </div>

          <!-- Buttons -->
          <div class="flex flex-wrap gap-3">
            <button id="btnSample" class="btn-ghost px-4 py-2 rounded-xl">Use Sample</button>
            <button id="btnLoad" class="btn-primary px-4 py-2 rounded-xl font-bold">Load Data</button>
            <button id="btnClear" class="btn-ghost px-4 py-2 rounded-xl">Clear</button>
          </div>

          <!-- Indicators -->
          <div class="pt-2">
            <div class="text-xs text-slate-400 mb-2">Indicators</div>
            <div class="grid grid-cols-2 gap-2">
              <button id="tSMA" class="off rounded-xl px-3 py-2 text-sm">SMA 14/50</button>
              <button id="tEMA" class="off rounded-xl px-3 py-2 text-sm">EMA 14</button>
              <button id="tBB" class="off rounded-xl px-3 py-2 text-sm">Bollinger</button>
              <button id="tHA" class="off rounded-xl px-3 py-2 text-sm">Heikin Ashi</button>
              <button id="tRSI" class="on rounded-xl px-3 py-2 text-sm">RSI</button>
              <button id="tMACD" class="on rounded-xl px-3 py-2 text-sm">MACD</button>
            </div>
          </div>

          <!-- Strategies -->
          <div class="pt-2">
            <div class="text-xs text-slate-400 mb-2">Strategies</div>
            <div class="grid grid-cols-2 gap-2">
              <button id="sGolden" class="on rounded-xl px-3 py-2 text-sm">Golden Cross</button>
              <button id="sRSI" class="on rounded-xl px-3 py-2 text-sm">RSI Zones</button>
              <button id="sBreak" class="on rounded-xl px-3 py-2 text-sm">Breakouts</button>
              <button id="sBB" class="on rounded-xl px-3 py-2 text-sm">BB Squeeze</button>
            </div>
          </div>

          <!-- Server -->
          <div class="grid grid-cols-1 gap-2">
            <div class="flex items-center justify-between">
              <span class="text-xs text-slate-400">Prediction source</span>
              <span id="serverState" class="text-[11px] px-2 py-1 rounded-md badge">Idle</span>
            </div>
            <select id="predictMode" class="w-full bg-[#0d1530] border border-[#293a69] rounded-xl p-3 text-slate-100">
              <option value="server-last">Server: send last OHLC to /api/candle</option>
              <option value="server-all">Server: send all candles to /api/predict</option>
              <option value="local">Local demo (no server)</option>
            </select>
            <input id="apiRoute" class="w-full bg-[#0d1530] border border-[#293a69] rounded-xl p-3 text-slate-100" value="/api/candle" placeholder="https://your-site.com/api/candle or /api/candle" />
            <div class="flex items-center gap-2">
              <button id="btnPredict" class="btn-primary px-4 py-2 rounded-xl font-bold pulse">Predict</button>
              <button id="btnNarrate" class="btn-ghost px-4 py-2 rounded-xl">AI Narrative</button>
              <button id="btnDownload" class="btn-ghost px-4 py-2 rounded-xl">Download</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="lg:col-span-2 grid gap-6">
        <!-- Candles + volume -->
        <div class="glass2 soft-shadow rounded-2xl overflow-hidden">
          <div class="flex items-center justify-between px-5 py-3 border-b border-[#1f2a44] bg-[#0b1325]">
            <div id="chartTitle" class="font-semibold">No data loaded</div>
            <div id="chartCursor" class="text-sm text-slate-400">‚Äî</div>
          </div>
          <div class="grid-dot">
            <div class="relative">
              <svg id="candleSVG" class="block w-full h-[420px]"></svg>
              <div id="tooltip" class="tip hidden absolute bg-[#020617] border border-[#293a69] text-slate-200 text-xs px-3 py-2 rounded-lg soft-shadow"></div>
            </div>
            <div class="relative border-t border-[#1f2a44]">
              <svg id="volSVG" class="block w-full h-[80px]"></svg>
            </div>
          </div>
        </div>

        <!-- RSI + MACD -->
        <div class="grid md:grid-cols-2 gap-6">
          <div class="glass2 soft-shadow rounded-2xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-[#1f2a44] bg-[#0b1325]">
              <div class="font-semibold">RSI (14)</div>
              <div id="rsiCursor" class="text-sm text-slate-400">‚Äî</div>
            </div>
            <div class="relative">
              <svg id="rsiSVG" class="block w-full h-[150px]"></svg>
            </div>
          </div>
          <div class="glass2 soft-shadow rounded-2xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-[#1f2a44] bg-[#0b1325]">
              <div class="font-semibold">MACD (12,26,9)</div>
              <div id="macdCursor" class="text-sm text-slate-400">‚Äî</div>
            </div>
            <div class="relative">
              <svg id="macdSVG" class="block w-full h-[150px]"></svg>
            </div>
          </div>
        </div>

        <!-- Insights -->
        <div class="grid md:grid-cols-3 gap-6">
          <div class="glass soft-shadow rounded-2xl p-5">
            <h3 class="panel-title font-bold mb-3">Quick Stats</h3>
            <div class="grid grid-cols-2 gap-3 text-slate-300">
              <div class="p-4 rounded-xl bg-[#0b132e] border border-[#1f2a44]">
                <div class="text-xs text-slate-400">Bars</div>
                <div id="statBars" class="text-2xl font-extrabold">‚Äî</div>
              </div>
              <div class="p-4 rounded-xl bg-[#0b132e] border border-[#1f2a44]">
                <div class="text-xs text-slate-400">Range</div>
                <div id="statRange" class="text-2xl font-extrabold">‚Äî</div>
              </div>
              <div class="p-4 rounded-xl bg-[#0b132e] border border-[#1f2a44]">
                <div class="text-xs text-slate-400">Last Close</div>
                <div id="statClose" class="text-2xl font-extrabold">‚Äî</div>
              </div>
              <div class="p-4 rounded-xl bg-[#0b132e] border border-[#1f2a44]">
                <div class="text-xs text-slate-400">Volatility</div>
                <div id="statVol" class="text-2xl font-extrabold">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="glass soft-shadow rounded-2xl p-5">
            <h3 class="panel-title font-bold mb-3">Signals</h3>
            <ul id="signalsList" class="space-y-2 text-sm">
              <li class="text-slate-400">No signals yet.</li>
            </ul>
          </div>

          <div class="glass soft-shadow rounded-2xl p-5">
            <div class="flex items-center justify-between">
              <h3 class="panel-title font-bold mb-3">Prediction</h3>
              <span id="predConfidence" class="text-[11px] px-2 py-1 rounded-md badge">‚Äî</span>
            </div>
            <div id="predictionBox" class="p-4 rounded-xl bg-[#0b132e] border border-[#1f2a44] text-slate-300">
              Load data to generate a prediction.
            </div>
          </div>
        </div>

        <!-- AI Narrative -->
        <div class="glass soft-shadow rounded-2xl p-5">
          <div class="flex items-center justify-between">
            <h3 class="panel-title font-bold">AI Narrative</h3>
            <span class="text-xs text-slate-400">Local, private, no cloud</span>
          </div>
          <p id="narrative" class="mt-3 text-slate-300">Click ‚ÄúAI Narrative‚Äù for an analyst-style summary of trend, momentum, and risk.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-6 md:px-10 pb-10 text-center text-slate-400">
    Crafted by Canva Code ¬∑ Beautiful by default ¬∑ Fully responsive
  </footer>

  <script>
    // State
    let rawCandles = [];   // original candles {t,o,h,l,c,v}
    let candles = [];      // possibly transformed (Heikin Ashi)
    let viewStart = 0, viewEnd = 0;
    let lastPrediction = null;

    // Elements
    const symbolPicker = document.getElementById('symbolPicker');
    const timeframeSel = document.getElementById('timeframe');
    const dataInput = document.getElementById('dataInput');
    const btnSample = document.getElementById('btnSample');
    const btnLoad = document.getElementById('btnLoad');
    const btnClear = document.getElementById('btnClear');

    const tSMA = document.getElementById('tSMA');
    const tEMA = document.getElementById('tEMA');
    const tBB = document.getElementById('tBB');
    const tHA = document.getElementById('tHA');
    const tRSI = document.getElementById('tRSI');
    const tMACD = document.getElementById('tMACD');

    const sGolden = document.getElementById('sGolden');
    const sRSI = document.getElementById('sRSI');
    const sBreak = document.getElementById('sBreak');
    const sBB = document.getElementById('sBB');

    const predictMode = document.getElementById('predictMode');
    const apiRouteInput = document.getElementById('apiRoute');
    const serverState = document.getElementById('serverState');
    const btnPredict = document.getElementById('btnPredict');
    const btnDownload = document.getElementById('btnDownload');
    const btnNarrate = document.getElementById('btnNarrate');

    const candleSVG = document.getElementById('candleSVG');
    const volSVG = document.getElementById('volSVG');
    const rsiSVG = document.getElementById('rsiSVG');
    const macdSVG = document.getElementById('macdSVG');
    const tooltip = document.getElementById('tooltip');

    const chartTitle = document.getElementById('chartTitle');
    const chartCursor = document.getElementById('chartCursor');
    const rsiCursor = document.getElementById('rsiCursor');
    const macdCursor = document.getElementById('macdCursor');

    const statBars = document.getElementById('statBars');
    const statRange = document.getElementById('statRange');
    const statClose = document.getElementById('statClose');
    const statVol = document.getElementById('statVol');
    const signalsList = document.getElementById('signalsList');
    const predictionBox = document.getElementById('predictionBox');
    const predConfidence = document.getElementById('predConfidence');
    const narrative = document.getElementById('narrative');

    // Helpers
    const on = (el)=>{ el.classList.add('on'); el.classList.remove('off'); }
    const off = (el)=>{ el.classList.add('off'); el.classList.remove('on'); }
    function toggle(el){ el.classList.toggle('on'); el.classList.toggle('off'); drawAll(); }

    function tfMs(){
      const v = timeframeSel.value;
      if(v==='1h') return 60*60*1000;
      if(v==='1d') return 24*60*60*1000;
      if(v==='15m') return 15*60*1000;
      if(v==='5m') return 5*60*1000;
      return 60*1000;
    }

    function isValidDateString(s){
      if(!s) return false; if(!isNaN(Number(s))) return false;
      const d = new Date(s); return !isNaN(d.getTime());
    }
    function parseInput(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out=[];
      for(const line of lines){
        const parts=line.split(/[,\s;]+/).map(x=>x.trim()).filter(Boolean);
        if(parts.length<4) continue;
        let t=null, o,h,l,c, v=null;
        if(parts.length>=6){
          if(isValidDateString(parts[0])) [t,o,h,l,c,v]=[parts[0],parts[1],parts[2],parts[3],parts[4],parts[5]];
          else [o,h,l,c,v]=[parts[0],parts[1],parts[2],parts[3],parts[4]];
        } else if(parts.length===5){
          if(isValidDateString(parts[0])) [t,o,h,l,c]=[parts[0],parts[1],parts[2],parts[3],parts[4]];
          else [o,h,l,c,v]=[parts[0],parts[1],parts[2],parts[3],parts[4]];
        } else { [o,h,l,c]=[parts[0],parts[1],parts[2],parts[3]]; }
        const O=Number(o),H=Number(h),L=Number(l),C=Number(c);
        if([O,H,L,C].some(x=>Number.isNaN(x))) continue;
        const when = t? new Date(t).toISOString(): null;
        const V = (v!=null && v!=='')? Number(v): null;
        out.push({t:when,o:O,h:H,l:L,c:C,v:V});
      }
      return out;
    }
    function ensureTimesIfMissing(arr){
      if(arr.length===0) return;
      if(!arr.every(c=>!c.t)) return;
      const step = tfMs();
      const start = Date.now()-arr.length*step;
      for(let i=0;i<arr.length;i++) arr[i].t = new Date(start + i*step).toISOString();
    }
    const nice=(n)=> Number.isFinite(n) ? (Math.abs(n)>=1000? n.toFixed(2): n.toFixed(4).replace(/0+$/,'').replace(/\.$/,'')) : '‚Äî';
    const fmt=(t)=>{ if(!t) return '‚Äî'; const d=new Date(t); return isNaN(d)? String(t): d.toLocaleString(); }
    function clearSVG(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

    // Indicators
    function SMA(src, p, acc){ const r=Array(src.length).fill(null); let sum=0; for(let i=0;i<src.length;i++){ const v=acc(src[i]); sum+=v; if(i>=p) sum-=acc(src[i-p]); if(i>=p-1) r[i]=sum/p; } return r; }
    function EMA(src, p, acc){ const r=Array(src.length).fill(null); const k=2/(p+1); let prev=null; for(let i=0;i<src.length;i++){ const v=acc(src[i]); prev=(prev===null)?v:(v-prev)*k+prev; if(i>=p-1) r[i]=prev; } return r; }
    function RSI(arr, p){ const r=Array(arr.length).fill(null); let ag=0, al=0; for(let i=1;i<arr.length;i++){ const ch=arr[i].c-arr[i-1].c; const g=Math.max(ch,0), l=Math.max(-ch,0); if(i<=p){ ag+=g; al+=l; if(i===p){ ag/=p; al/=p; const rs=al===0? 100: ag/al; r[i]=100-(100/(1+rs)); } } else { ag=(ag*(p-1)+g)/p; al=(al*(p-1)+l)/p; const rs=al===0? 100: ag/al; r[i]=100-(100/(1+rs)); } } return r; }
    function Bollinger(arr, p=20, k=2){ const mid=SMA(arr,p,d=>d.c); const up=Array(arr.length).fill(null); const dn=Array(arr.length).fill(null); for(let i=p-1;i<arr.length;i++){ const slice=arr.slice(i-p+1,i+1).map(d=>d.c); const m=mid[i]; const v=slice.reduce((s,x)=>s+(x-m)*(x-m),0)/p; const sd=Math.sqrt(v); up[i]=m+k*sd; dn[i]=m-k*sd; } return {mid,up,dn}; }
    function MACD(arr, fast=12, slow=26, signal=9){
      const emaF = EMA(arr, fast, d=>d.c);
      const emaS = EMA(arr, slow, d=>d.c);
      const macd = arr.map((_,i)=>(emaF[i]!=null && emaS[i]!=null)? (emaF[i]-emaS[i]) : null);
      const sig = EMA(macd.map((v,i)=>({c:v??0})), signal, d=>d.c);
      const hist = macd.map((v,i)=> (v!=null && sig[i]!=null) ? v - sig[i] : null);
      return {macd, sig, hist};
    }
    function HeikinAshi(src){
      if(src.length===0) return [];
      const out=[];
      let haC = (src[0].o + src[0].h + src[0].l + src[0].c)/4;
      let haO = (src[0].o + src[0].c)/2;
      let haH = Math.max(src[0].h, haO, haC);
      let haL = Math.min(src[0].l, haO, haC);
      out.push({t:src[0].t,o:haO,h:haH,l:haL,c:haC,v:src[0].v??null});
      for(let i=1;i<src.length;i++){
        haC = (src[i].o + src[i].h + src[i].l + src[i].c)/4;
        haO = (out[i-1].o + out[i-1].c)/2;
        haH = Math.max(src[i].h, haO, haC);
        haL = Math.min(src[i].l, haO, haC);
        out.push({t:src[i].t,o:haO,h:haH,l:haL,c:haC,v:src[i].v??null});
      }
      return out;
    }

    // Sample data
    function makeSample(n=220, start=100){
      const step = tfMs();
      const t0 = Date.now()-n*step;
      const rows=[];
      let base=start + Math.random()*5;
      for(let i=0;i<n;i++){
        const drift = Math.sin(i/18)*0.18 + Math.cos(i/9)*0.12;
        const noise = (Math.random()-0.5)*0.6;
        const o = base;
        const c = Math.max(1, o*(1 + (drift+noise)*0.002));
        const h = Math.max(o,c) * (1 + Math.random()*0.004);
        const l = Math.min(o,c) * (1 - Math.random()*0.004);
        const v = Math.floor(1000 + Math.random()*5000);
        rows.push({t:new Date(t0 + i*step).toISOString(), o:+o.toFixed(2), h:+h.toFixed(2), l:+l.toFixed(2), c:+c.toFixed(2), v});
        base=c;
      }
      return rows;
    }

    // Stats & Signals
    function computeStats(arr){
      if(arr.length===0){ statBars.textContent='‚Äî'; statRange.textContent='‚Äî'; statClose.textContent='‚Äî'; statVol.textContent='‚Äî'; return; }
      const lows=arr.map(d=>d.l), highs=arr.map(d=>d.h);
      const range = Math.max(...highs) - Math.min(...lows);
      const lastC = arr[arr.length-1].c;
      // simple volatility using returns std
      const rets = []; for(let i=1;i<arr.length;i++){ rets.push((arr[i].c/arr[i-1].c)-1); }
      const mu = rets.reduce((a,b)=>a+b,0)/(rets.length||1);
      const std = Math.sqrt(rets.reduce((s,x)=>s+(x-mu)*(x-mu),0)/(rets.length||1));
      statBars.textContent = arr.length;
      statRange.textContent = nice(range);
      statClose.textContent = nice(lastC);
      statVol.textContent = (std*100).toFixed(2)+'%';
    }

    function buildSignals(arr){
      const n = arr.length;
      const out=[];
      if(n<3){ signalsList.innerHTML = '<li class="text-slate-400">Not enough data for signals.</li>'; return; }
      const sma14 = SMA(arr,14,d=>d.c), sma50=SMA(arr,50,d=>d.c), sma200=SMA(arr,200,d=>d.c);
      const ema14 = EMA(arr,14,d=>d.c);
      const rsi14 = RSI(arr,14);
      const {mid,up,dn} = Bollinger(arr,20,2);
      const {macd,sig,hist} = MACD(arr,12,26,9);

      const mom = arr[n-1].c - arr[n-4]?.c;
      if(mom>0) out.push({t:'positive', label:'Momentum up'});
      if(mom<0) out.push({t:'negative', label:'Momentum down'});

      if(sma50[n-1]!=null && sma200[n-1]!=null){
        if(sma50[n-2]!=null && sma200[n-2]!=null){
          const crossUp = sma50[n-2] <= sma200[n-2] && sma50[n-1] > sma200[n-1];
          const crossDn = sma50[n-2] >= sma200[n-2] && sma50[n-1] < sma200[n-1];
          if(crossUp) out.push({t:'positive', label:'Golden Cross (50>200)'});
          if(crossDn) out.push({t:'negative', label:'Death Cross (50<200)'});
        }
      }

      if(ema14[n-1]!=null){
        if(arr[n-1].c > ema14[n-1]) out.push({t:'positive', label:'Close above EMA(14)'});
        else out.push({t:'negative', label:'Close below EMA(14)'});
      }

      if(rsi14[n-1]!=null){
        if(rsi14[n-1] > 70) out.push({t:'neutral', label:'RSI overbought'});
        else if(rsi14[n-1] < 30) out.push({t:'neutral', label:'RSI oversold'});
        else out.push({t:'neutral', label:'RSI neutral'});
      }

      if(mid[n-1]!=null){
        const width=(up[n-1]-dn[n-1])/(mid[n-1]||1);
        if(width<0.02) out.push({t:'neutral', label:'BB squeeze (low volatility)'});
      }

      if(hist[n-1]!=null && hist[n-2]!=null){
        if(hist[n-1]>0 && hist[n-2]<=0) out.push({t:'positive', label:'MACD momentum turns positive'});
        if(hist[n-1]<0 && hist[n-2]>=0) out.push({t:'negative', label:'MACD momentum turns negative'});
      }

      signalsList.innerHTML='';
      if(out.length===0){ signalsList.innerHTML='<li class="text-slate-400">No signals yet.</li>'; return; }
      for(const s of out){
        const cls = s.t==='positive' ? 'border-emerald-700/40 bg-emerald-900/20 text-emerald-300' :
                    s.t==='negative' ? 'border-rose-700/40 bg-rose-900/20 text-rose-300' :
                                       'border-cyan-700/40 bg-cyan-900/20 text-cyan-200';
        const li=document.createElement('li');
        li.className='px-3 py-2 rounded-lg border text-sm '+cls;
        li.textContent=s.label;
        signalsList.appendChild(li);
      }
    }

    // Heikin vs Raw view
    function refreshViewSeries(){
      candles = tHA.classList.contains('on') ? HeikinAshi(rawCandles) : rawCandles.slice();
    }

    // Drawing
    function drawAll(){
      refreshViewSeries();
      computeStats(candles);
      drawCandles();
      drawRSI();
      drawMACD();
      buildSignals(candles);
    }

    function drawCandles(){
      clearSVG(candleSVG); clearSVG(volSVG);
      if(candles.length===0){ chartTitle.textContent='No data loaded'; chartCursor.textContent='‚Äî'; return; }
      chartTitle.textContent = `${symbolPicker.value} ¬∑ ${timeframeSel.value} ¬∑ ${fmt(candles[0].t)} ‚Üí ${fmt(candles[candles.length-1].t)}`;

      const width = candleSVG.clientWidth || 900;
      const height = candleSVG.clientHeight || 420;
      const padL=60, padR=20, padT=16, padB=28;
      const plotW = width - padL - padR;
      const plotH = height - padT - padB;

      viewStart = 0; viewEnd = candles.length;
      const data = candles.slice(viewStart, viewEnd);
      const minL = Math.min(...data.map(d=>d.l));
      const maxH = Math.max(...data.map(d=>d.h));
      const y = (p)=> padT + (maxH - p) * (plotH / Math.max(1e-8,(maxH-minL)));
      const step = Math.max(3, plotW/Math.max(1, data.length-1));
      const x = (i)=> padL + i*step + step*0.5;

      // Grid + Y labels
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const yTicks=5;
      for(let i=0;i<=yTicks;i++){
        const yy = padT + (plotH/yTicks)*i;
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', padL); line.setAttribute('x2', padL+plotW);
        line.setAttribute('y1', yy); line.setAttribute('y2', yy);
        line.setAttribute('stroke', '#1e293b');
        line.setAttribute('stroke-width','1');
        g.appendChild(line);

        const price = maxH - ((maxH-minL)/yTicks)*i;
        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', 10);
        label.setAttribute('y', yy+4);
        label.setAttribute('fill', '#8fa1c1');
        label.setAttribute('font-size','11');
        label.textContent = nice(price);
        candleSVG.appendChild(label);
      }
      candleSVG.appendChild(g);

      // Bollinger?
      if(tBB.classList.contains('on')){
        const bb=Bollinger(candles,20,2);
        const pathU=document.createElementNS('http://www.w3.org/2000/svg','path');
        const pathM=document.createElementNS('http://www.w3.org/2000/svg','path');
        const pathD=document.createElementNS('http://www.w3.org/2000/svg','path');
        let du='', dm='', dd='';
        for(let i=0;i<data.length;i++){
          const gi=viewStart+i;
          if(bb.up[gi]!=null){ du+=(du===''?'M':' L')+x(i)+' '+y(bb.up[gi]); }
          if(bb.mid[gi]!=null){ dm+=(dm===''?'M':' L')+x(i)+' '+y(bb.mid[gi]); }
          if(bb.dn[gi]!=null){ dd+=(dd===''?'M':' L')+x(i)+' '+y(bb.dn[gi]); }
        }
        pathU.setAttribute('d',du); pathU.setAttribute('fill','none'); pathU.setAttribute('stroke','#22d3ee'); pathU.setAttribute('stroke-width','1.5');
        pathM.setAttribute('d',dm); pathM.setAttribute('fill','none'); pathM.setAttribute('stroke','#94a3b8'); pathM.setAttribute('stroke-dasharray','4 3'); pathM.setAttribute('stroke-width','1');
        pathD.setAttribute('d',dd); pathD.setAttribute('fill','none'); pathD.setAttribute('stroke','#22d3ee'); pathD.setAttribute('stroke-width','1.5');
        candleSVG.appendChild(pathU); candleSVG.appendChild(pathM); candleSVG.appendChild(pathD);
      }

      // Candles
      const useBull='#22c55e', useBear='#ef4444';
      for(let i=0;i<data.length;i++){
        const d=data[i];
        const yyO=y(d.o), yyC=y(d.c), yyH=y(d.h), yyL=y(d.l);
        const cx=x(i);

        const wick=document.createElementNS('http://www.w3.org/2000/svg','line');
        wick.setAttribute('x1',cx); wick.setAttribute('x2',cx);
        wick.setAttribute('y1',yyH); wick.setAttribute('y2',yyL);
        wick.setAttribute('stroke', d.c>=d.o? useBull: useBear);
        wick.setAttribute('stroke-width','2');
        candleSVG.appendChild(wick);

        const body=document.createElementNS('http://www.w3.org/2000/svg','rect');
        const h=Math.max(2, Math.abs(yyC-yyO));
        body.setAttribute('x', cx - Math.max(2, step*0.35));
        body.setAttribute('y', Math.min(yyO,yyC));
        body.setAttribute('width', Math.max(3, step*0.7));
        body.setAttribute('height', h);
        body.setAttribute('fill', d.c>=d.o? useBull: useBear);
        body.setAttribute('opacity','0.9');
        body.addEventListener('mouseenter', ()=>{
          tooltip.classList.remove('hidden');
          tooltip.innerHTML = `
            <div class="font-semibold">${fmt(d.t)}</div>
            <div>O: <b>${nice(d.o)}</b> H: <b>${nice(d.h)}</b></div>
            <div>L: <b>${nice(d.l)}</b> C: <b>${nice(d.c)}</b></div>
          `;
          chartCursor.textContent = `${fmt(d.t)} ¬∑ O ${nice(d.o)} ¬∑ H ${nice(d.h)} ¬∑ L ${nice(d.l)} ¬∑ C ${nice(d.c)}`;
        });
        body.addEventListener('mousemove', (e)=>{
          const rect=e.target.ownerSVGElement.getBoundingClientRect();
          tooltip.style.left=(e.clientX-rect.left+12)+'px';
          tooltip.style.top=(e.clientY-rect.top+12)+'px';
        });
        body.addEventListener('mouseleave', ()=>{
          tooltip.classList.add('hidden');
          chartCursor.textContent='‚Äî';
        });
        candleSVG.appendChild(body);
      }

      // SMA/EMA?
      if(tSMA.classList.contains('on')){
        const sma14=SMA(candles,14,d=>d.c);
        const sma50=SMA(candles,50,d=>d.c);
        const drawLine=(arr, color, w=2, dash=null)=>{
          const p=document.createElementNS('http://www.w3.org/2000/svg','path');
          let d='';
          for(let i=0;i<data.length;i++){
            const gi=viewStart+i;
            if(arr[gi]==null) continue;
            d+=(d===''?'M':' L')+x(i)+' '+y(arr[gi]);
          }
          p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke',color); p.setAttribute('stroke-width',w);
          if(dash) p.setAttribute('stroke-dasharray',dash);
          candleSVG.appendChild(p);
        };
        drawLine(sma14, '#22d3ee', 2);
        drawLine(sma50, '#a78bfa', 2, '6 3');
      }
      if(tEMA.classList.contains('on')){
        const ema14=EMA(candles,14,d=>d.c);
        const p=document.createElementNS('http://www.w3.org/2000/svg','path');
        let d=''; for(let i=0;i<data.length;i++){ const gi=viewStart+i; if(ema14[gi]==null) continue; d+=(d===''?'M':' L')+x(i)+' '+y(ema14[gi]); }
        p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke','#14f195'); p.setAttribute('stroke-width','2');
        candleSVG.appendChild(p);
      }

      // Volume
      const vw = volSVG.clientWidth || width;
      const vh = volSVG.clientHeight || 80;
      const pL=60,pR=20,pT=8,pB=16;
      const pw=vw-pL-pR, ph=vh-pT-pB;
      const vMax = Math.max(1, ...data.map(d=>d.v||0));
      const vx=(i)=> pL + i*(pw/Math.max(1,(data.length-1)));
      for(let i=0;i<data.length;i++){
        const d=data[i];
        const h=(ph*((d.v||0)/vMax));
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', vx(i)-Math.max(1, (pw/Math.max(1,(data.length-1)))*0.35));
        rect.setAttribute('y', pT + (ph-h));
        rect.setAttribute('width', Math.max(2, (pw/Math.max(1,(data.length-1)))*0.7));
        rect.setAttribute('height', Math.max(2,h));
        rect.setAttribute('fill', d.c>=d.o ? '#10b981' : '#f43f5e');
        rect.setAttribute('opacity','0.65');
        volSVG.appendChild(rect);
      }
    }

    function drawRSI(){
      clearSVG(rsiSVG);
      if(candles.length===0 || !tRSI.classList.contains('on')) return;
      const width=rsiSVG.clientWidth||600, height=rsiSVG.clientHeight||150;
      const pL=60,pR=20,pT=10,pB=20, pw=width-pL-pR, ph=height-pT-pB;
      const rsi14=RSI(candles,14);
      const x=(i)=> pL + i*(pw/Math.max(1,(candles.length-1)));
      const y=(v)=> pT + (100 - v) * (ph/100);

      // bands
      const bands=[30,50,70];
      for(const lvl of bands){
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', pL); line.setAttribute('x2', pL+pw);
        line.setAttribute('y1', y(lvl)); line.setAttribute('y2', y(lvl));
        line.setAttribute('stroke', lvl===50 ? '#334155' : '#1f2a44');
        line.setAttribute('stroke-width','1');
        rsiSVG.appendChild(line);

        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', 10); label.setAttribute('y', y(lvl)+4);
        label.setAttribute('fill','#8fa1c1'); label.setAttribute('font-size','11');
        label.textContent = lvl; rsiSVG.appendChild(label);
      }

      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      let d=''; for(let i=0;i<candles.length;i++){ if(rsi14[i]==null) continue; d+=(d===''?'M':' L')+x(i)+' '+y(rsi14[i]); }
      path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','#22d3ee'); path.setAttribute('stroke-width','2');
      rsiSVG.appendChild(path);

      rsiCursor.textContent = (rsi14[rsi14.length-1]!=null) ? `RSI: ${rsi14[rsi14.length-1].toFixed(1)}` : '‚Äî';
    }

    function drawMACD(){
      clearSVG(macdSVG);
      if(candles.length===0 || !tMACD.classList.contains('on')) return;
      const width=macdSVG.clientWidth||600, height=macdSVG.clientHeight||150;
      const pL=60,pR=20,pT=10,pB=20, pw=width-pL-pR, ph=height-pT-pB;

      const {macd, sig, hist} = MACD(candles,12,26,9);
      const vals = [...macd, ...sig, ...hist].filter(v=>v!=null);
      const min = Math.min(...vals), max = Math.max(...vals);
      const x=(i)=> pL + i*(pw/Math.max(1,(candles.length-1)));
      const y=(v)=> pT + (max - v) * (ph/Math.max(1e-8,(max-min)));

      // zero line
      const zero=document.createElementNS('http://www.w3.org/2000/svg','line');
      zero.setAttribute('x1', pL); zero.setAttribute('x2', pL+pw);
      zero.setAttribute('y1', y(0)); zero.setAttribute('y2', y(0));
      zero.setAttribute('stroke','#334155'); zero.setAttribute('stroke-width','1');
      macdSVG.appendChild(zero);

      // histogram bars
      for(let i=0;i<candles.length;i++){
        if(hist[i]==null) continue;
        const cx=x(i);
        const y0=y(0), yh=y(hist[i]);
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', cx - Math.max(1,(pw/Math.max(1,(candles.length-1)))*0.35));
        rect.setAttribute('width', Math.max(2,(pw/Math.max(1,(candles.length-1)))*0.7));
        rect.setAttribute('y', Math.min(y0,yh));
        rect.setAttribute('height', Math.max(2, Math.abs(yh-y0)));
        rect.setAttribute('fill', hist[i]>=0 ? '#22c55e' : '#ef4444');
        rect.setAttribute('opacity','0.6');
        macdSVG.appendChild(rect);
      }

      // macd and signal
      const drawLine=(arr,color)=>{
        const p=document.createElementNS('http://www.w3.org/2000/svg','path'); let d='';
        for(let i=0;i<candles.length;i++){ if(arr[i]==null) continue; d+=(d===''?'M':' L')+x(i)+' '+y(arr[i]); }
        p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke',color); p.setAttribute('stroke-width','2'); macdSVG.appendChild(p);
      };
      drawLine(macd, '#22d3ee'); drawLine(sig, '#a78bfa');

      const last = candles.length-1;
      macdCursor.textContent = (macd[last]!=null && sig[last]!=null) ? `MACD: ${macd[last].toFixed(3)} ‚Ä¢ Signal: ${sig[last].toFixed(3)}` : '‚Äî';
    }

    // Local prediction (demo)
    function makeLocalPrediction(){
      if(candles.length<20){
        predictionBox.textContent = 'Need at least 20 bars for a demo prediction.';
        predConfidence.textContent = '‚Äî';
        return;
      }
      const close = candles.map(d=>d.c);
      const last = close.length-1;
      const mom = close[last] - close[last-3];
      const sma14=SMA(candles,14,d=>d.c), ema14=EMA(candles,14,d=>d.c), rsi14=RSI(candles,14);
      const bb=Bollinger(candles,20,2); const mac=MACD(candles,12,26,9);

      const pos=[], neg=[];
      if(mom>0) pos.push('Momentum positive'); else neg.push('Momentum negative');
      if(ema14[last]!=null){ (close[last]>ema14[last])? pos.push('Close > EMA14') : neg.push('Close < EMA14'); }
      if(sma14[last]!=null && sma14[last-1]!=null){ (sma14[last]>sma14[last-1])? pos.push('SMA14 rising') : neg.push('SMA14 falling'); }
      if(rsi14[last]!=null){ if(rsi14[last]>70) neg.push('RSI overbought'); else if(rsi14[last]<30) pos.push('RSI oversold'); }

      const score = pos.length - neg.length;
      let direction='Sideways'; if(score>=2) direction='Bullish'; else if(score<=-2) direction='Bearish';
      const conf = Math.min(96, Math.max(55, 60 + score*8 + (Math.abs(mom)/(close[last]*0.01)) ));
      predConfidence.textContent = `${Math.round(conf)}% confidence`;
      const emoji = direction==='Bullish' ? 'üü¢' : direction==='Bearish' ? 'üî¥' : 'üü°';
      predictionBox.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="text-2xl">${emoji}</div>
          <div>
            <div class="text-lg font-extrabold">${direction} next candle</div>
            <ul class="mt-2 space-y-1 text-sm text-slate-300">
              ${pos.map(s=>`<li>‚úÖ ${s}</li>`).join('')}
              ${neg.map(s=>`<li>‚ö†Ô∏è ${s}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
      lastPrediction = {prediction:direction, confidence:Math.round(conf), positives:pos, negatives:neg, symbol:symbolPicker.value, timeframe:timeframeSel.value, lastClose:close[last], lastTime:candles[last].t};
      return lastPrediction;
    }

    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function downloadJSON(obj, name='prediction.json'){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // AI Narrative (local, stylistic)
    function makeNarrative(){
      if(candles.length<20){ narrative.textContent='Load more data for a richer narrative.'; return; }
      const last=candles.length-1;
      const rsi14=RSI(candles,14); const {macd,sig,hist}=MACD(candles,12,26,9);
      const sma50=SMA(candles,50,d=>d.c), sma200=SMA(candles,200,d=>d.c);
      const bb=Bollinger(candles,20,2);
      const aboveLong = sma200[last]!=null && candles[last].c > sma200[last];
      const trend = (sma50[last]!=null && sma200[last]!=null) ? (sma50[last]>sma200[last] ? 'uptrend' : 'downtrend') : 'unclear trend';
      const rsiNote = rsi14[last]==null ? 'RSI forming' : rsi14[last]>70 ? 'overbought' : rsi14[last]<30 ? 'oversold' : 'neutral';
      const macNote = (macd[last]!=null && sig[last]!=null) ? (macd[last]>sig[last] ? 'bullish momentum' : 'bearish momentum') : 'momentum forming';
      const width = (bb.up[last]!=null && bb.dn[last]!=null && bb.mid[last]!=null) ? ( (bb.up[last]-bb.dn[last])/(bb.mid[last]||1) ) : null;
      const squeeze = (width!=null && width<0.02) ? 'volatility squeeze' : 'normal volatility';

      narrative.innerHTML = `
        <div class="text-slate-200">
          <span class="neon-p font-bold">Outlook:</span> ${trend}, ${macNote}, ${squeeze}.<br/>
          <span class="text-slate-300">Context:</span> Price ${aboveLong? 'trades above':'sits below'} the long view. RSI is ${rsiNote}.<br/>
          <span class="text-slate-300">Note:</span> This is a local, stylistic summary ‚Äî not advice.
        </div>
      `;
    }

    // Actions
    btnSample.addEventListener('click', ()=>{
      const start = symbolPicker.value.includes('NIFTY') ? 45700 : 2850;
      const rows = makeSample(240, start);
      dataInput.value = rows.map(r=>`${r.o},${r.h},${r.l},${r.c},${r.v}`).join('\n');
    });

    btnClear.addEventListener('click', ()=>{
      dataInput.value=''; rawCandles=[]; candles=[]; clearSVG(candleSVG); clearSVG(volSVG); clearSVG(rsiSVG); clearSVG(macdSVG);
      chartTitle.textContent='No data loaded'; chartCursor.textContent='‚Äî'; rsiCursor.textContent='‚Äî'; macdCursor.textContent='‚Äî';
      signalsList.innerHTML = '<li class="text-slate-400">No signals yet.</li>';
      predictionBox.textContent = 'Load data to generate a prediction.';
      predConfidence.textContent='‚Äî';
      narrative.textContent='Click ‚ÄúAI Narrative‚Äù for an analyst-style summary of trend, momentum, and risk.';
      computeStats([]);
    });

    btnLoad.addEventListener('click', ()=>{
      const parsed = parseInput(dataInput.value);
      if(parsed.length<5){
        predictionBox.innerHTML = '<span class="text-rose-300">Couldn‚Äôt read your data. Need at least 5 rows.</span>';
        return;
      }
      ensureTimesIfMissing(parsed);
      rawCandles = parsed;
      drawAll();
      predictionBox.textContent = 'Data loaded. Click Predict or AI Narrative.';
      predConfidence.textContent='‚Äî';
    });

    // Indicator toggles
    tSMA.addEventListener('click', ()=>toggle(tSMA));
    tEMA.addEventListener('click', ()=>toggle(tEMA));
    tBB.addEventListener('click', ()=>toggle(tBB));
    tHA.addEventListener('click', ()=>toggle(tHA));
    tRSI.addEventListener('click', ()=>toggle(tRSI));
    tMACD.addEventListener('click', ()=>toggle(tMACD));

    // Strategy toggles (impact: Signals logic uses them implicitly by presence; for demo we keep UI alive)
    sGolden.addEventListener('click', ()=>toggle(sGolden));
    sRSI.addEventListener('click', ()=>toggle(sRSI));
    sBreak.addEventListener('click', ()=>toggle(sBreak));
    sBB.addEventListener('click', ()=>toggle(sBB));

    btnNarrate.addEventListener('click', makeNarrative);

    btnPredict.addEventListener('click', async ()=>{
      if(rawCandles.length<1){ alert('Please load some data first.'); return; }
      serverState.textContent='Working‚Ä¶';
      serverState.className='text-[11px] px-2 py-1 rounded-md badge';
      const mode=predictMode.value.trim();
      const route=(apiRouteInput?.value||'').trim();

      if(mode==='local' || !route){
        const res=makeLocalPrediction();
        serverState.textContent='Local demo';
        return;
      }

      try{
        let res,isOK,data={};
        if(mode==='server-last'){
          const last = rawCandles[rawCandles.length-1];
          res = await fetch(route, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({open:last.o, high:last.h, low:last.l, close:last.c}) });
        } else {
          const route2 = route.includes('predict') ? route : route.replace(/candle$/,'predict');
          res = await fetch(route2, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol:symbolPicker.value, timeframe:timeframeSel.value, candles: rawCandles}) });
        }
        isOK = res.ok;
        try{ data = await res.json(); }catch{}

        if(isOK && (data.prediction || data.result || data.reply)){
          const text = escapeHTML(String(data.prediction || data.result || data.reply));
          predConfidence.textContent = data.confidence ? String(data.confidence)+'%' : '‚Äî';
          predictionBox.innerHTML = `
            <div class="space-y-2">
              <div class="text-sm text-slate-300">Server response</div>
              <pre class="bg-[#0b132e] border border-[#1f2a44] p-3 rounded-lg whitespace-pre-wrap text-slate-200 text-sm">${text}</pre>
            </div>
          `;
          lastPrediction = data;
          serverState.textContent='Online';
          serverState.className='text-[11px] px-2 py-1 rounded-md on';
        } else {
          const local=makeLocalPrediction();
          serverState.textContent='Unreachable';
          serverState.className='text-[11px] px-2 py-1 rounded-md badge';
          predictionBox.innerHTML += `<div class="mt-2 text-rose-300">Server not reachable. Used local demo instead.</div>`;
          if(local) lastPrediction=local;
        }
      }catch(err){
        const local=makeLocalPrediction();
        serverState.textContent='Error';
        serverState.className='text-[11px] px-2 py-1 rounded-md badge';
        predictionBox.innerHTML += `<div class="mt-2 text-rose-300">Error: ${escapeHTML(err.message||String(err))}. Used local demo.</div>`;
        if(local) lastPrediction=local;
      }
    });

    btnDownload.addEventListener('click', ()=>{
      if(!lastPrediction){
        const res=makeLocalPrediction(); if(!res) return; lastPrediction=res;
      }
      downloadJSON(lastPrediction, `prediction_${symbolPicker.value.replace(':','_')}_${timeframeSel.value}.json`);
    });

    // Initial UI defaults
    on(tRSI); on(tMACD); off(tSMA); off(tEMA); off(tBB); off(tHA);
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972807c932328f9e',t:'MTc1NTc1NzI4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
