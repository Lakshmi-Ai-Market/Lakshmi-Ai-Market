<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîÆ AI Candle Predictor ‚Äî Lakshmi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --grad-a:#fdf2f8;
      --grad-b:#ecfeff;
      --ink:#0f172a;
    }
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 10%, var(--grad-a), transparent),
        radial-gradient(900px 700px at 90% 0%, var(--grad-b), transparent),
        linear-gradient(180deg, #fff 0%, #fdf4ff 100%);
      color: var(--ink);
    }
    .glass{ backdrop-filter: blur(8px); background: rgba(255,255,255,0.75); }
    .soft-shadow{ box-shadow: 0 10px 30px rgba(17,24,39,0.08), 0 2px 6px rgba(17,24,39,0.06); }
    .ring-focus:focus{ outline: none; box-shadow: 0 0 0 4px rgba(214,51,132,0.25); }
    .tip{ pointer-events:none; }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-7xl mx-auto px-6 md:px-10 pt-8 pb-4">
    <div class="flex items-start md:items-center justify-between gap-6 flex-col md:flex-row">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-pink-500 to-fuchsia-600 flex items-center justify-center text-white text-2xl">üîÆ</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900">AI Candle Predictor ‚Äî Lakshmi</h1>
          <p class="text-slate-600">Paste OHLC/OHLCV (time optional), visualize, and get a prediction.</p>
        </div>
      </div>
      <a href="/dashboard" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white hover:bg-slate-50 text-pink-700 font-semibold soft-shadow transition">
        ‚Üê Back to Dashboard
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 md:px-10 pb-16">
    <section class="grid lg:grid-cols-3 gap-6">
      <!-- Input Panel -->
      <div class="lg:col-span-1 glass rounded-2xl soft-shadow p-5 md:p-6">
        <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">üì• Data Input</h2>
        <p class="text-slate-600 text-sm mt-1">
          Formats accepted:
          - open,high,low,close[,volume]
          - time,open,high,low,close[,volume]
          Time is optional. Avoid thousand separators (use 45700, not 45,700).
        </p>

        <textarea id="dataInput" rows="8" class="mt-4 w-full ring-1 ring-slate-200 rounded-xl p-3 ring-focus placeholder-slate-400" placeholder="45710,45745,45690,45720,152300
45720,45750,45700,45735,141900
..."></textarea>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <select id="timeframe" class="w-full ring-1 ring-slate-200 rounded-xl p-3 ring-focus">
            <option value="1m">1 Minute</option>
            <option value="5m" selected>5 Minutes</option>
            <option value="15m">15 Minutes</option>
            <option value="1h">1 Hour</option>
          </select>
          <select id="symbolPicker" class="w-full ring-1 ring-slate-200 rounded-xl p-3 ring-focus">
            <option value="NSE:NIFTY">Symbol: NSE:NIFTY</option>
            <option value="NSE:BANKNIFTY">Symbol: NSE:BANKNIFTY</option>
            <option value="NSE:RELIANCE">Symbol: NSE:RELIANCE</option>
          </select>
          <input id="apiRoute" class="col-span-2 w-full ring-1 ring-slate-200 rounded-xl p-3 ring-focus" placeholder="Your server route (https://.../api/candle or /api/candle)" value="/api/candle" />
        </div>

        <div class="mt-4 flex flex-wrap gap-3">
          <button id="btnLoad" class="px-4 py-2.5 rounded-xl bg-pink-600 hover:bg-pink-700 text-white font-semibold transition">Load Data</button>
          <button id="btnSample" class="px-4 py-2.5 rounded-xl bg-white hover:bg-slate-50 text-slate-800 font-semibold soft-shadow transition">Use Sample</button>
          <button id="btnClear" class="px-4 py-2.5 rounded-xl bg-white hover:bg-slate-50 text-slate-800 font-semibold soft-shadow transition">Clear</button>
        </div>

        <div class="mt-5 p-4 rounded-xl bg-white/70 ring-1 ring-slate-200 space-y-2">
          <div class="flex items-center justify-between gap-3">
            <p class="text-sm text-slate-600">Server route:</p>
            <span id="serverState" class="text-xs px-2 py-1 rounded-lg bg-slate-100 text-slate-700">Tap Predict to test</span>
          </div>
          <div class="text-sm text-slate-600 break-all">
            <span class="font-semibold">Route:</span> <span id="serverRouteText">/api/candle</span>
          </div>
          <p class="text-xs text-slate-500">Heads up: Your route must be public https and allow this page to call it. Localhost won‚Äôt work here.</p>
        </div>
      </div>

      <!-- Chart Panel -->
      <div class="lg:col-span-2 glass rounded-2xl soft-shadow p-5 md:p-6">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">üìà Chart</h2>
          <div class="flex items-center gap-2 flex-wrap">
            <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 cursor-pointer">
              <input id="toggleSMA" type="checkbox" class="accent-pink-600"> <span class="text-sm font-semibold">SMA (14)</span>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 cursor-pointer">
              <input id="toggleEMA" type="checkbox" class="accent-pink-600"> <span class="text-sm font-semibold">EMA (14)</span>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 cursor-pointer">
              <input id="toggleRSI" type="checkbox" class="accent-pink-600" checked> <span class="text-sm font-semibold">RSI (14)</span>
            </label>
            <button id="btnResetZoom" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 text-slate-800 font-semibold soft-shadow transition">Reset Zoom</button>
          </div>
        </div>

        <div class="mt-4 grid gap-4">
          <!-- Main Candles -->
          <div class="rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white">
            <div class="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-white to-pink-50">
              <div id="chartTitle" class="font-semibold text-slate-800">No data loaded</div>
              <div id="chartCursor" class="text-sm text-slate-600">‚Äî</div>
            </div>
            <div class="relative">
              <svg id="candleSVG" class="block w-full h-[360px] bg-white"></svg>
              <div id="tooltip" class="tip hidden absolute bg-slate-900/90 text-white text-xs px-3 py-2 rounded-lg soft-shadow"></div>
            </div>
          </div>
          <!-- RSI -->
          <div id="rsiWrap" class="rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white">
            <div class="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-white to-pink-50">
              <div class="font-semibold text-slate-800">RSI (14)</div>
              <div id="rsiCursor" class="text-sm text-slate-600">‚Äî</div>
            </div>
            <div class="relative">
              <svg id="rsiSVG" class="block w-full h-[120px] bg-white"></svg>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Insights & Prediction -->
    <section class="mt-6 grid lg:grid-cols-3 gap-6">
      <!-- Stats -->
      <div class="glass rounded-2xl soft-shadow p-5 md:p-6">
        <h3 class="text-lg font-bold text-slate-900 mb-3">üìä Quick Stats</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 rounded-xl bg-white ring-1 ring-slate-200">
            <div class="text-slate-500 text-sm">Bars</div>
            <div id="statBars" class="text-2xl font-extrabold">‚Äî</div>
          </div>
          <div class="p-4 rounded-xl bg-white ring-1 ring-slate-200">
            <div class="text-slate-500 text-sm">Range</div>
            <div id="statRange" class="text-2xl font-extrabold">‚Äî</div>
          </div>
          <div class="p-4 rounded-xl bg-white ring-1 ring-slate-200">
            <div class="text-slate-500 text-sm">Last Close</div>
            <div id="statClose" class="text-2xl font-extrabold">‚Äî</div>
          </div>
          <div class="p-4 rounded-xl bg-white ring-1 ring-slate-200">
            <div class="text-slate-500 text-sm">Volatility</div>
            <div id="statVol" class="text-2xl font-extrabold">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Signals -->
      <div class="glass rounded-2xl soft-shadow p-5 md:p-6">
        <h3 class="text-lg font-bold text-slate-900 mb-3">üß≠ Signals</h3>
        <ul id="signalsList" class="space-y-2">
          <li class="text-slate-600">No signals yet.</li>
        </ul>
      </div>

      <!-- Prediction -->
      <div class="glass rounded-2xl soft-shadow p-5 md:p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-slate-900 mb-3">üîî Prediction</h3>
          <span id="predConfidence" class="text-xs px-2 py-1 rounded-lg bg-pink-100 text-pink-700 font-semibold">‚Äî</span>
        </div>
        <div id="predictionBox" class="p-4 rounded-xl bg-white ring-1 ring-slate-200">
          <div class="text-slate-600">Load data to generate a prediction.</div>
        </div>
        <div class="mt-3 flex flex-wrap gap-3">
          <button id="btnPredict" class="px-4 py-2.5 rounded-xl bg-pink-600 hover:bg-pink-700 text-white font-semibold transition">Predict Next Candle</button>
          <button id="btnDownload" class="px-4 py-2.5 rounded-xl bg-white hover:bg-slate-50 text-slate-800 font-semibold soft-shadow transition">Download Report</button>
        </div>
        <p class="mt-3 text-xs text-slate-500">
          If your route is reachable, you'll see your server‚Äôs reply. Otherwise a demo result is shown. Not financial advice.
        </p>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-6 md:px-10 pb-10 text-center text-slate-500">
    Built with care by Lakshmi ¬∑ Crafted by Canva Code
  </footer>

  <script>
    // State
    let candles = []; // {t, o, h, l, c, v}
    let viewStart = 0;
    let viewEnd = 0;
    let lastPrediction = null;

    // Elements
    const dataInput = document.getElementById('dataInput');
    const timeframeSel = document.getElementById('timeframe');
    const symbolPicker = document.getElementById('symbolPicker');
    const btnLoad = document.getElementById('btnLoad');
    const btnSample = document.getElementById('btnSample');
    const btnClear = document.getElementById('btnClear');
    const apiRouteInput = document.getElementById('apiRoute');
    const serverState = document.getElementById('serverState');
    const serverRouteText = document.getElementById('serverRouteText');

    const toggleSMA = document.getElementById('toggleSMA');
    const toggleEMA = document.getElementById('toggleEMA');
    const toggleRSI = document.getElementById('toggleRSI');
    const btnResetZoom = document.getElementById('btnResetZoom');

    const candleSVG = document.getElementById('candleSVG');
    const rsiSVG = document.getElementById('rsiSVG');
    const rsiWrap = document.getElementById('rsiWrap');
    const tooltip = document.getElementById('tooltip');

    const chartTitle = document.getElementById('chartTitle');
    aconst chartCursor = document.getElementById('chartCursor');
    const rsiCursor = document.getElementById('rsiCursor');

    const statBars = document.getElementById('statBars');
    const statRange = document.getElementById('statRange');
    const statClose = document.getElementById('statClose');
    const statVol = document.getElementById('statVol');

    const signalsList = document.getElementById('signalsList');

    const predictionBox = document.getElementById('predictionBox');
    const predConfidence = document.getElementById('predConfidence');
    const btnPredict = document.getElementById('btnPredict');
    const btnDownload = document.getElementById('btnDownload');

    // Utils
    function isValidDateString(s){
      if(!s) return false;
      if(!isNaN(Number(s))) return false;
      const d = new Date(s);
      return !isNaN(d.getTime());
    }
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Accept OHLC, OHLCV, or time+OHLC(+V)
    function parseInput(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = [];
      for(const line of lines){
        const parts = line.split(/[,\s;]+/).map(x=>x.trim()).filter(Boolean);
        if(parts.length < 4) continue;

        let t = null, o, h, l, c, v = null;

        if(parts.length >= 6){
          if(isValidDateString(parts[0])){
            [t, o, h, l, c, v] = [parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]];
          } else {
            [o, h, l, c, v] = [parts[0], parts[1], parts[2], parts[3], parts[4]];
          }
        } else if(parts.length === 5){
          if(isValidDateString(parts[0])){
            [t, o, h, l, c] = [parts[0], parts[1], parts[2], parts[3], parts[4]];
          } else {
            [o, h, l, c, v] = [parts[0], parts[1], parts[2], parts[3], parts[4]];
          }
        } else {
          [o, h, l, c] = [parts[0], parts[1], parts[2], parts[3]];
        }

        const open = Number(o), high = Number(h), low = Number(l), close = Number(c);
        if([open,high,low,close].some(x=>Number.isNaN(x))) continue;

        const when = t ? new Date(t).toISOString() : null;
        const vol = (v!=null && v!=='') ? Number(v) : null;

        out.push({t: when, o: open, h: high, l: low, c: close, v: vol});
      }
      return out;
    }

    function ensureTimesIfMissing(){
      if(candles.length===0) return;
      const allMissing = candles.every(c=>!c.t);
      if(!allMissing) return;
      const step = timeframeSel.value==='1h' ? 60*60*1000 :
                   timeframeSel.value==='15m' ? 15*60*1000 :
                   timeframeSel.value==='5m' ? 5*60*1000 : 60*1000;
      const start = Date.now() - candles.length*step;
      for(let i=0;i<candles.length;i++){
        candles[i].t = new Date(start + i*step).toISOString();
      }
    }

    function sma(arr, period, acc){ const res=new Array(arr.length).fill(null); let sum=0; for(let i=0;i<arr.length;i++){ const v=acc(arr[i]); sum+=v; if(i>=period) sum-=acc(arr[i-period]); if(i>=period-1) res[i]=sum/period; } return res; }
    function ema(arr, period, acc){ const res=new Array(arr.length).fill(null); const k=2/(period+1); let prev=null; for(let i=0;i<arr.length;i++){ const v=acc(arr[i]); prev=(prev===null)?v:(v-prev)*k+prev; if(i>=period-1) res[i]=prev; } return res; }
    function rsi(arr, period){
      const res = new Array(arr.length).fill(null);
      let avgGain=0, avgLoss=0;
      for(let i=1;i<arr.length;i++){
        const ch = arr[i].c - arr[i-1].c;
        const gain = Math.max(ch,0), loss = Math.max(-ch,0);
        if(i<=period){
          avgGain += gain; avgLoss += loss;
          if(i===period){
            avgGain/=period; avgLoss/=period;
            const rs = avgLoss===0 ? 100 : avgGain/avgLoss;
            res[i] = 100 - (100/(1+rs));
          }
        } else {
          avgGain = (avgGain*(period-1) + gain)/period;
          avgLoss = (avgLoss*(period-1) + loss)/period;
          const rs = avgLoss===0 ? 100 : avgGain/avgLoss;
          res[i] = 100 - (100/(1+rs));
        }
      }
      return res;
    }

    function niceNumber(n){
      return Number.isFinite(n) ? (Math.abs(n)>=1000 ? n.toFixed(2) : n.toFixed(4).replace(/0+$/,'').replace(/\.$/,'')) : '‚Äî';
    }
    function fmtTime(t){
      if(!t) return '‚Äî';
      const d = new Date(t);
      return isNaN(d.getTime()) ? String(t) : d.toLocaleString();
    }

    function computeStats(){
      if(candles.length===0){ statBars.textContent='‚Äî'; statRange.textContent='‚Äî'; statClose.textContent='‚Äî'; statVol.textContent='‚Äî'; return; }
      const lows = candles.map(c=>c.l), highs = candles.map(c=>c.h);
      const minL = Math.min(...lows), maxH = Math.max(...highs);
      const range = maxH - minL;
      const lastC = candles[candles.length-1].c;
      const rets = [];
      for(let i=1;i<candles.length;i++){ rets.push((candles[i].c/candles[i-1].c)-1); }
      const mu = rets.reduce((a,b)=>a+b,0)/(rets.length||1);
      const std = Math.sqrt(rets.reduce((s,x)=>s+(x-mu)*(x-mu),0)/(rets.length||1));
      const volPct = (std*100).toFixed(2)+'%';

      statBars.textContent = candles.length;
      statRange.textContent = niceNumber(range);
      statClose.textContent = niceNumber(lastC);
      statVol.textContent = volPct;
    }

    function buildSignals(sma14, ema14, rsi14){
      const items = [];
      const n = candles.length;
      if(n<3){ signalsList.innerHTML = '<li class="text-slate-600">Not enough data for signals.</li>'; return; }

      const mom = candles[n-1].c - candles[n-3].c;
      if(mom>0) items.push({label:'Momentum up', tone:'positive'});
      if(mom<0) items.push({label:'Momentum down', tone:'negative'});

      if(sma14[n-1]!=null){
        if(candles[n-1].c > sma14[n-1]) items.push({label:'Price above SMA(14)', tone:'positive'});
        else items.push({label:'Price below SMA(14)', tone:'negative'});
      }
      if(ema14[n-1]!=null && ema14[n-2]!=null){
        if(ema14[n-1] > ema14[n-2]) items.push({label:'EMA(14) rising', tone:'positive'});
        else items.push({label:'EMA(14) falling', tone:'negative'});
      }

      if(rsi14[n-1]!=null){
        if(rsi14[n-1] > 70) items.push({label:'RSI overbought (>70)', tone:'neutral'});
        else if(rsi14[n-1] < 30) items.push({label:'RSI oversold (<30)', tone:'neutral'});
        else items.push({label:'RSI neutral', tone:'neutral'});
      }

      signalsList.innerHTML = '';
      if(items.length===0){
        signalsList.innerHTML = '<li class="text-slate-600">No signals yet.</li>';
        return;
      }
      for(const it of items){
        const color = it.tone==='positive' ? 'text-emerald-700 bg-emerald-50 ring-emerald-100' :
                      it.tone==='negative' ? 'text-rose-700 bg-rose-50 ring-rose-100' :
                                             'text-slate-700 bg-slate-50 ring-slate-200';
        const li = document.createElement('li');
        li.className = `px-3 py-2 rounded-lg ring-1 ${color} text-sm font-semibold`;
        li.textContent = it.label;
        signalsList.appendChild(li);
      }
    }

    function clearSVG(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

    function drawChart(){
      clearSVG(candleSVG);
      clearSVG(rsiSVG);
      if(candles.length===0){
        chartTitle.textContent = 'No data loaded';
        chartCursor.textContent = '‚Äî';
        rsiCursor.textContent = '‚Äî';
        return;
      }
      const width = candleSVG.clientWidth || 800;
      const height = candleSVG.clientHeight || 360;
      const padL=50, padR=20, padT=10, padB=24;
      const plotW = width - padL - padR;
      const plotH = height - padT - padB;

      const vs = viewEnd - viewStart;
      const data = candles.slice(viewStart, viewEnd);

      const minL = Math.min(...data.map(d=>d.l));
      const maxH = Math.max(...data.map(d=>d.h));
      const yScale = (p)=> padT + (maxH - p) * (plotH / Math.max(1e-8, (maxH - minL)));

      // Y grid + labels
      const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
      const yTicks = 5;
      for(let i=0;i<=yTicks;i++){
        const y = padT + (plotH/yTicks)*i;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', padL); line.setAttribute('x2', padL+plotW);
        line.setAttribute('y1', y); line.setAttribute('y2', y);
        line.setAttribute('stroke', i===yTicks ? '#e2e8f0' : '#f1f5f9');
        line.setAttribute('stroke-width', '1');
        grid.appendChild(line);

        const price = maxH - ( (maxH-minL)/yTicks )*i;
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', 8);
        label.setAttribute('y', y+4);
        label.setAttribute('fill', '#64748b');
        label.setAttribute('font-size', '11');
        label.textContent = niceNumber(price);
        candleSVG.appendChild(label);
      }
      candleSVG.appendChild(grid);

      const step = Math.max(3, plotW/Math.max(1,vs-1));
      const xAt = (i)=> padL + i*step + step*0.5;

      // Indicators
      const sma14 = sma(candles, 14, d=>d.c);
      const ema14 = ema(candles, 14, d=>d.c);
      const rsi14 = rsi(candles, 14);

      // Candles
      for(let i=0;i<data.length;i++){
        const d = data[i];
        const gi = viewStart + i;
        const x = xAt(i);
        const yO = yScale(d.o), yC = yScale(d.c), yH = yScale(d.h), yL = yScale(d.l);

        const wick = document.createElementNS('http://www.w3.org/2000/svg','line');
        wick.setAttribute('x1', x);
        wick.setAttribute('x2', x);
        wick.setAttribute('y1', yH);
        wick.setAttribute('y2', yL);
        wick.setAttribute('stroke', d.c>=d.o ? '#22c55e' : '#ef4444');
        wick.setAttribute('stroke-width', '2');
        candleSVG.appendChild(wick);

        const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
        const bodyH = Math.max(2, Math.abs(yC - yO));
        body.setAttribute('x', x - Math.max(2, step*0.35));
        body.setAttribute('y', Math.min(yO, yC));
        body.setAttribute('width', Math.max(3, step*0.7));
        body.setAttribute('height', bodyH);
        body.setAttribute('fill', d.c>=d.o ? '#22c55e' : '#ef4444');
        body.setAttribute('opacity', '0.9');
        body.style.cursor = 'crosshair';
        body.addEventListener('mouseenter', ()=>{
          tooltip.classList.remove('hidden');
          tooltip.innerHTML = `
            <div class="font-semibold">${fmtTime(d.t)}</div>
            <div>O: <b>${niceNumber(d.o)}</b>  H: <b>${niceNumber(d.h)}</b></div>
            <div>L: <b>${niceNumber(d.l)}</b>  C: <b>${niceNumber(d.c)}</b></div>
          `;
          chartCursor.textContent = `${fmtTime(d.t)} ¬∑ O ${niceNumber(d.o)} ¬∑ H ${niceNumber(d.h)} ¬∑ L ${niceNumber(d.l)} ¬∑ C ${niceNumber(d.c)}`;
          if(rsi14[gi]!=null){
            rsiCursor.textContent = `RSI: ${rsi14[gi].toFixed(1)}`;
          } else {
            rsiCursor.textContent = '‚Äî';
          }
        });
        body.addEventListener('mousemove', (e)=>{
          const rect = e.target.ownerSVGElement.getBoundingClientRect();
          tooltip.style.left = (e.clientX - rect.left + 12) + 'px';
          tooltip.style.top = (e.clientY - rect.top + 12) + 'px';
        });
        body.addEventListener('mouseleave', ()=>{
          tooltip.classList.add('hidden');
          chartCursor.textContent = '‚Äî';
          rsiCursor.textContent = '‚Äî';
        });
        candleSVG.appendChild(body);
      }

      // SMA
      if(toggleSMA.checked){
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        let d = '';
        for(let i=0;i<data.length;i++){
          const gi = viewStart + i;
          if(sma14[gi]==null) continue;
          d += (d===''?'M':' L') + xAt(i) + ' ' + yScale(sma14[gi]);
        }
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','#0ea5e9');
        path.setAttribute('stroke-width','2');
        candleSVG.appendChild(path);
      }

      // EMA
      if(toggleEMA.checked){
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        let d = '';
        for(let i=0;i<data.length;i++){
          const gi = viewStart + i;
          if(ema14[gi]==null) continue;
          d += (d===''?'M':' L') + xAt(i) + ' ' + yScale(ema14[gi]);
        }
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','#a21caf');
        path.setAttribute('stroke-width','2');
        candleSVG.appendChild(path);
      }

      // RSI
      rsiWrap.style.display = toggleRSI.checked ? 'block' : 'none';
      if(toggleRSI.checked){
        const w = rsiSVG.clientWidth || 800;
        const h = rsiSVG.clientHeight || 120;
        const pL=50,pR=20,pT=8,pB=18;
        const pw = w - pL - pR;
        const ph = h - pT - pB;
        const step2 = Math.max(3, pw/Math.max(1,vs-1));
        const x2 = (i)=> pL + i*step2 + step2*0.5;

        const yRSI = (v)=> pT + (100 - v) * (ph/100);
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        for(const lvl of [30,50,70]){
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', pL); line.setAttribute('x2', pL+pw);
          line.setAttribute('y1', yRSI(lvl)); line.setAttribute('y2', yRSI(lvl));
          line.setAttribute('stroke', lvl===50 ? '#e2e8f0' : '#f1f5f9');
          line.setAttribute('stroke-width', '1');
          g.appendChild(line);

          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 8);
          label.setAttribute('y', yRSI(lvl)+4);
          label.setAttribute('fill', '#64748b');
          label.setAttribute('font-size', '11');
          label.textContent = lvl;
          rsiSVG.appendChild(label);
        }
        rsiSVG.appendChild(g);

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        let d2 = '';
        for(let i=0;i<data.length;i++){
          const gi = viewStart + i;
          if(rsi14[gi]==null) continue;
          d2 += (d2===''?'M':' L') + x2(i) + ' ' + yRSI(rsi14[gi]);
        }
        path.setAttribute('d', d2);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','#ef4444');
        path.setAttribute('stroke-width','2');
        rsiSVG.appendChild(path);
      }

      const sym = symbolPicker.value;
      chartTitle.textContent = `${sym} ¬∑ ${timeframeSel.value} ¬∑ ${fmtTime(data[0]?.t)} ‚Üí ${fmtTime(data[data.length-1]?.t)}`;

      const sma14all = sma(candles,14,d=>d.c);
      const ema14all = ema(candles,14,d=>d.c);
      const rsi14all = rsi(candles,14);
      buildSignals(sma14all, ema14all, rsi14all);
      computeStats();

      // Drag zoom
      let dragStart = null;
      candleSVG.onmousedown = (e)=>{
        const rect = candleSVG.getBoundingClientRect();
        dragStart = e.clientX - rect.left;
      };
      candleSVG.onmouseup = (e)=>{
        if(dragStart===null) return;
        const rect = candleSVG.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const a = Math.min(dragStart, x), b=Math.max(dragStart, x);
        const startIdx = Math.max(0, Math.floor((a - padL)/step));
        const endIdx = Math.min(candles.length, Math.ceil((b - padL)/step));
        if(endIdx - startIdx >= 10){
          viewStart += startIdx;
          viewEnd = viewStart + (endIdx - startIdx);
          viewStart = Math.max(0, Math.min(viewStart, candles.length-10));
          viewEnd = Math.max(viewStart+10, Math.min(viewEnd, candles.length));
          drawChart();
        }
        dragStart = null;
      };
    }

    function resetView(){ viewStart = 0; viewEnd = candles.length; }

    // Simple on-page demo prediction if server not reachable
    function makeLocalPrediction(){
      if(candles.length<20){
        predictionBox.innerHTML = `<div class="text-slate-600">Need at least 20 bars for a demo prediction.</div>`;
        predConfidence.textContent = '‚Äî';
        return;
      }
      const close = candles.map(d=>d.c);
      const last = close.length-1;
      const mom = close[last] - close[last-3];
      const sma14v = sma(candles,14,d=>d.c);
      const ema14v = ema(candles,14,d=>d.c);
      const rsi14v = rsi(candles,14);

      const bullish = [];
      const bearish = [];

      if(mom>0) bullish.push('Short-term momentum positive'); else bearish.push('Short-term momentum negative');
      if(ema14v[last]!=null){ (close[last] > ema14v[last]) ? bullish.push('Price above EMA(14)') : bearish.push('Price below EMA(14)'); }
      if(sma14v[last]!=null && sma14v[last-1]!=null){ (sma14v[last] > sma14v[last-1]) ? bullish.push('SMA(14) rising') : bearish.push('SMA(14) falling'); }

      const r = rsi14v[last];
      let rsiNote = 'RSI neutral';
      if(r!=null){
        if(r>70){ bearish.push('RSI overbought'); rsiNote='RSI overbought'; }
        else if(r<30){ bullish.push('RSI oversold'); rsiNote='RSI oversold'; }
      }

      const score = bullish.length - bearish.length;
      let direction = 'Sideways';
      if(score>=2) direction = 'Bullish';
      else if(score<=-2) direction = 'Bearish';

      const conf = Math.min(95, Math.max(55, 60 + score*7 + (Math.abs(mom)/(close[last]*0.01)) ));
      predConfidence.textContent = `${Math.round(conf)}% confidence`;
      const emoji = direction==='Bullish' ? 'üü¢' : direction==='Bearish' ? 'üî¥' : 'üü°';

      predictionBox.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="text-2xl">${emoji}</div>
          <div>
            <div class="text-lg font-extrabold">${direction} next candle</div>
            <ul class="mt-2 space-y-1 text-sm text-slate-700">
              ${bullish.map(s=>`<li>‚úÖ ${s}</li>`).join('')}
              ${bearish.map(s=>`<li>‚ö†Ô∏è ${s}</li>`).join('')}
              <li>üìå ${rsiNote}</li>
            </ul>
          </div>
        </div>
      `;
      return {direction, confidence: Math.round(conf), bullish, bearish, rsi: r, timeframe: timeframeSel.value, symbol: symbolPicker.value, lastTime: candles[last].t, lastClose: candles[last].c};
    }

    function downloadJSON(obj, name='prediction.json'){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Buttons
    btnSample.addEventListener('click', ()=>{
      // Sample OHLCV without time (NIFTY-like values)
      const rows = [
        '45710,45745,45690,45720,152300',
        '45720,45750,45700,45735,141900',
        '45735,45760,45710,45740,133200',
        '45740,45780,45720,45765,128400',
        '45765,45790,45730,45750,119800',
        '45750,45770,45710,45725,125600',
        '45725,45755,45700,45740,131400',
        '45740,45785,45720,45780,127900',
        '45780,45810,45760,45800,121300',
        '45800,45820,45770,45795,118700',
        '45795,45825,45760,45810,115600',
        '45810,45845,45790,45830,113200'
      ];
      dataInput.value = rows.join('\n');
    });

    btnClear.addEventListener('click', ()=>{
      dataInput.value = '';
      candles = [];
      resetView();
      drawChart();
      signalsList.innerHTML = '<li class="text-slate-600">No signals yet.</li>';
      predictionBox.innerHTML = `<div class="text-slate-600">Load data to generate a prediction.</div>`;
      predConfidence.textContent = '‚Äî';
      chartTitle.textContent = 'No data loaded';
      chartCursor.textContent = '‚Äî';
      rsiCursor.textContent = '‚Äî';
      computeStats();
    });

    btnLoad.addEventListener('click', ()=>{
      const parsed = parseInput(dataInput.value);
      if(parsed.length<5){
        predConfidence.textContent = '‚Äî';
        predictionBox.innerHTML = `<div class="text-rose-700">Couldn‚Äôt read your data. Paste rows like: open,high,low,close[,volume] (time optional). Need at least 5 rows.</div>`;
        return;
      }
      candles = parsed;
      ensureTimesIfMissing();
      resetView();
      drawChart();
      computeStats();
      predConfidence.textContent = '‚Äî';
      predictionBox.innerHTML = `<div class="text-slate-700">Data loaded. Now click ‚ÄúPredict Next Candle‚Äù.</div>`;
    });

    toggleSMA.addEventListener('change', drawChart);
    toggleEMA.addEventListener('change', drawChart);
    toggleRSI.addEventListener('change', drawChart);
    btnResetZoom.addEventListener('click', ()=>{ resetView(); drawChart(); });

    btnPredict.addEventListener('click', async ()=>{
      if(candles.length<1){
        alert('Please load some data first.');
        return;
      }
      const last = candles[candles.length-1];
      predictionBox.innerHTML = `<div class="text-slate-600">Requesting prediction from your server‚Ä¶</div>`;
      predConfidence.textContent = '‚Äî';
      const route = (apiRouteInput?.value || '/api/candle').trim();
      if(serverRouteText) serverRouteText.textContent = route;

      try{
        const payload = { open: last.o, high: last.h, low: last.l, close: last.c };
        const res = await fetch(route, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const isOK = res.ok;
        let data = {};
        try{ data = await res.json(); }catch{ /* ignore */ }

        if(isOK && data && (typeof data.prediction === 'string')){
          lastPrediction = data;
          predConfidence.textContent = '‚Äî';
          predictionBox.innerHTML = `
            <div class="space-y-2">
              <div class="text-lg font-extrabold">Server result</div>
              <pre class="bg-slate-50 p-3 rounded-lg whitespace-pre-wrap text-sm">${escapeHTML(data.prediction)}</pre>
            </div>
          `;
          serverState.textContent = 'Online';
          serverState.className = 'text-xs px-2 py-1 rounded-lg bg-emerald-100 text-emerald-700';
        } else {
          // Fallback to local demo
          const local = makeLocalPrediction();
          if(local) lastPrediction = local;
          serverState.textContent = 'Unreachable';
          serverState.className = 'text-xs px-2 py-1 rounded-lg bg-rose-100 text-rose-700';
        }
      }catch(err){
        const local = makeLocalPrediction();
        if(local) lastPrediction = local;
        predictionBox.innerHTML += `<div class="mt-2 text-rose-700">Server error: ${String(err.message||err)}. Used demo logic instead.</div>`;
        serverState.textContent = 'Unreachable';
        serverState.className = 'text-xs px-2 py-1 rounded-lg bg-rose-100 text-rose-700';
      }
    });

    btnDownload.addEventListener('click', ()=>{
      if(!lastPrediction){
        const local = makeLocalPrediction();
        if(local) lastPrediction = local;
      }
      if(lastPrediction){
        downloadJSON(lastPrediction, `prediction_${symbolPicker.value}_${timeframeSel.value}.json`);
      }
    });

    // Init
    // (We no longer ping the server automatically since your Flask route accepts POST only.)
    function reflectRoute(){
      const route = (apiRouteInput?.value || '/api/candle').trim();
      if(serverRouteText) serverRouteText.textContent = route;
      serverState.textContent = 'Tap Predict to test';
      serverState.className = 'text-xs px-2 py-1 rounded-lg bg-slate-100 text-slate-700';
    }
    apiRouteInput?.addEventListener('change', reflectRoute);
    apiRouteInput?.addEventListener('blur', reflectRoute);
    reflectRoute();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9727f522832e3386',t:'MTc1NTc1NjUyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
